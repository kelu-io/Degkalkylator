<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ü•ñ Degkalkylator</title>
  <style>
    /* =============================
       Reset & Base
    ============================ */
    html, body {
      min-height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, system-ui, sans-serif;
      background: #0f0f12;
      color: #f2f2f7;
      transition: background 0.3s, color 0.3s;
    }
    body {
      min-height: 100vh;
      padding: 20px;
      background: inherit;
    }

    /* =============================
       Layout
    ============================ */
    .container {
      background: #1c1c1e;
      padding: 20px;
      border-radius: 14px;
      max-width: 420px;
      margin: auto;
    }

    /* =============================
       Typography & Text
    ============================ */
    label { display: block; margin-top: 12px; font-weight: 600; color: #d1d1d6; transition: color 0.3s; }
    p, strong { color: #f2f2f7; transition: color 0.3s; }
    hr { border: none; border-top: 1px solid #3a3a3c; margin: 20px 0; }

    /* =============================
       Inputs
    ============================ */
    input { width: 65%; padding: 8px; font-size: 18px; margin-top: 6px; border-radius: 10px; border: 1px solid #3a3a3c; background: #2c2c2e; color: #ffffff; transition: all 0.3s; }

    /* =============================
       Toggle rows (shared)
    ============================ */
    .toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .toggle-row input { display: none; }
    .switch { width: 46px; height: 26px; background: #4a4a4c; border-radius: 13px; position: relative; cursor: pointer; }
    .switch::after { content: ""; width: 22px; height: 22px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: transform 0.25s ease; }
    .toggle-row input:checked + .switch { background: #34c759; }
    .toggle-row input:checked + .switch::after { transform: translateX(20px); }

    /* =============================
       F√∂rdeg (collapse)
    ============================ */
    #prefSection { overflow: hidden; max-height: 2000px; opacity: 1; transition: max-height 0.35s ease, opacity 0.25s ease; }
    #prefSection.collapsed { max-height: 0; opacity: 0; pointer-events: none; }

    /* =============================
       Mj√∂lmix (collapse)
    ============================ */
    #flourMixSection { overflow: hidden; max-height: 2000px; opacity: 1; transition: max-height 0.35s ease, opacity 0.25s ease; }
    #flourMixSection.collapsed { max-height: 0; opacity: 0; pointer-events: none; }
    #flourMixSection p { margin-bottom: 0; }

    /* =============================
       Settings
    ============================ */
    #settingsBtn { background: none; border: none; font-size: 22px; cursor: pointer; float: right; margin-top: -26px; margin-right: -12px; }
    .settings-panel { margin-top: 14px; padding: 16px; border-radius: 14px; background: #2c2c2e; display: none; animation: settingsFade 0.25s ease-out; }
    .settings-panel.open { display: block; }
    .settings-panel h2 { margin: 0 0 4px; font-size: 15px; color: #b0b0b5; }
    .settings-panel h3 { margin: 0 0 12px; font-size: 18px; }
    .settings-panel h4 { margin: 14px 0 6px; font-size: 13px; color: #b0b0b5; text-transform: uppercase; letter-spacing: 0.04em; }
    @keyframes settingsFade { from { opacity:0; transform:translateY(-6px);} to {opacity:1; transform:translateY(0);} }

    /* =============================
       Recipe
    ============================ */
    .recipe-section { margin-top: 10px; }
    .recipe-section.collapsed { display: none; }
    #settingsPanel .settings-btn, #settingsPanel select { width: 48%; padding: 8px; font-size: 16px; border-radius: 10px; margin-top: 8px; background: #3a3a3c; border: 1px solid #3a3a3c; color: #f2f2f7; -webkit-appearance: none; cursor: pointer; transition: all 0.2s; }
    #recipeSelect { width: 45%; padding: 8px; font-size: 16px; margin-top: 6px; border-radius: 10px; background: #3a3a3c; color:#fff; border:1px solid #3a3a3c; -webkit-appearance:none; appearance:none; transition: all 0.3s; }
    #recipeNameInput { width: 92%; padding: 8px; font-size: 16px; background: #3a3a3c; }

    /* =============================
       Reset-knapp i settings
    ============================ */
    .reset-icon {
      display: block;
      margin: 20px auto;
      font-size: 26px;
      color: #ff3b30 !important;
      background: #3a3a3c;
      border: 1px solid #3a3a3c;
      border-radius: 12px;
      cursor: pointer;
      text-align: center;
      transition: transform 0.15s ease, opacity 0.15s ease;
    }

    /* =============================
       Light mode
    ============================ */
    html.light { background: #f2f2f7; }
    body.light { background: #f2f2f7; color: #000; }
    body.light .container { background: #fff; }
    body.light label, body.light p, body.light strong { color: #000; }
    body.light input { background:#f2f2f7; color:#000; border:1px solid #ccc; }
    body.light hr { border-top:1px solid #ccc; }
    body.light .settings-panel { background:#f2f2f7; }
  	body.light .settings-panel h2 { color:#666; }
    body.light .settings-panel h4 { color:#666; }
    body.light #settingsPanel button, body.light #settingsPanel select { background:#f9f9f9; border:1px solid #ccc; color:#000; }
    body.light #settingsPanel button:hover, body.light #settingsPanel select:hover { background:#e0e0e0; }
    body.light .switch { background: #d1d1d6; }
    body.light .toggle-row input:checked + .switch { background: #34c759; }
    body.light .switch::after { background: #ffffff; }
  	body.light #recipeSelect { background:#f2f2f7; color:#000; border:1px solid #ccc; appearance:none; -webkit-appearance:none; }
    body.light #recipeNameInput { background: #f9f9f9; width: 90%; padding: 8px; font-size: 16px; }

  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <header class="app-header">
      <button id="settingsBtn" aria-label="Inst√§llningar">‚öôÔ∏è</button>
      <h1>Degkalkylator</h1>
    </header>

    <!-- Settings Panel -->
    <div id="settingsPanel" class="settings-panel">
      <h3>Inst√§llningar</h3>

      <h4>Utseende</h4>
      <label class="toggle-row">
        <div class="toggle-left"><span id="themeIcon">üåô</span> <span>M√∂rkt / ljust l√§ge</span></div>
        <input type="checkbox" id="themeToggle"><span class="switch"></span>
      </label>

      <hr>

      <h4>Ber√§kning</h4>
      <label class="toggle-row">
        <span>ü•£ Anv√§nd f√∂rdeg</span>
        <input type="checkbox" id="usePref"><span class="switch"></span>
      </label>

      <label class="toggle-row">
        <span>üåæ Mj√∂lmix</span>
        <input type="checkbox" id="useFlourMix"><span class="switch"></span>
      </label>

      <hr>

      <h4>Data</h4>
      <label class="toggle-row">
        <span>üìñ Recept</span>
        <input type="checkbox" id="recipeToggle"><span class="switch"></span>
      </label>

      <!-- Recept -->
      <div id="recipeSection" class="recipe-section collapsed">
        <h2>Skapa dina recept lokalt:</h2>
        <input type="text" id="recipeNameInput" placeholder="Namn p√• recept...">
        <button id="saveRecipeBtn" class="settings-btn">üíæ Spara</button>
        <button id="deleteRecipeBtn" class="settings-btn">üóë Radera</button>
        <hr>
        <h2>Spara backup av dina recept:</h2>
        <button id="exportRecipesBtn" class="settings-btn">üì§ Spara</button>
        <input type="file" id="importRecipesInput" accept=".json" style="display:none;">
        <button id="importRecipesBtn" class="settings-btn">üì• Ladda</button>
      </div>

      <!-- √Öterst√§ll data -->
      <hr>
      <button id="resetAppBtn" class="settings-btn reset-icon">
        üîÑ √Öterst√§ll
      </button>
    </div>

    <!-- V√§lj recept -->
    <section id="recipeSelectorSection">
      <label>
        üìÇ V√§lj recept
        <select id="recipeSelect">
          <option value="">‚Äì Inget recept ‚Äì</option>
        </select>
      </label>
    </section>

    <!-- Inputs -->
    <section class="base-inputs">
      <label>‚öñÔ∏è Total degvikt (g)</label>
      <input type="number" id="totalDoughInput" value="1000">
    </section>

    <section id="prefSection" class="collapsed">
      <hr>
      <h2>F√∂rdeg</h2>
      <label>Andel av total deg (%)</label>
      <input type="number" id="prefPct" value="0">
      <label>Hydration f√∂rdeg (%)</label>
      <input type="number" id="prefHyd" value="100">
      <label>J√§st f√∂rdeg (%)</label>
      <input type="number" id="prefYeastPct" value="0.1" step="0.01">
      <p>üåæ Mj√∂l: <strong><span id="prefFlour">0</span> g</strong></p>
      <p>üíß Vatten: <strong><span id="prefWater">0</span> g</strong></p>
      <p>üçû J√§st: <strong><span id="prefYeast">0</span> g</strong></p>
      <p>‚öñÔ∏è F√∂rdeg totalt: <strong><span id="prefTotal">0</span> g</strong></p>
    </section>

    <section class="main-dough">
      <hr>
      <h2>Huvuddeg</h2>
      <label>Hydration (%)</label>
      <input type="number" id="waterPct" value="65">
      <label>Salt (%)</label>
      <input type="number" id="saltPct" value="2.5">
      <label>J√§st (%)</label>
      <input type="number" id="yeastPct" value="1.0">
  	  <section id="flourMixSection" class="collapsed">
        <label>Mj√∂lmix (%)</label>
        <input type="number" id="flourMixPct" value="0" min="0" max="50">
    		<p>üåæ Mj√∂lmix: <strong id="flourMix"></strong> g</p>
  	  </section>
      <p>üåæ Mj√∂l: <strong><span id="mainFlour">0</span> g</strong></p>
      <p>üíß Vatten: <strong><span id="mainWater">0</span> g</strong></p>
      <p>üßÇ Salt: <strong><span id="salt">0</span> g</strong></p>
      <p>üçû J√§st: <strong><span id="yeast">0</span> g</strong></p>
      <p>‚öñÔ∏è Huvuddeg totalt: <strong><span id="mainTotal">0</span> g</strong></p>
    </section>

    <section class="totals">
      <hr>
      <h2>Totalt</h2>
      <p>üåæ Totalt mj√∂l: <strong><span id="totalFlour">0</span> g</strong></p>
      <p>üíß Totalt vatten: <strong><span id="totalWater">0</span> g</strong></p>
      <p>‚öñÔ∏è Total deg: <strong><span id="totalCheck">0</span> g</strong></p>
    </section>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded",()=> {
      
      // --- App PIN-skydd ---
      (() => {
        const APP_PIN = "1234";
        // redan godk√§nd?
        if (localStorage.getItem("appAuthorized") === "1") return;
        const pin = prompt("üîí Ange PIN-kod");
        if (pin !== APP_PIN) {
          document.body.innerHTML = `
            <div style="
              display:flex;
              align-items:center;
              justify-content:center;
              height:100vh;
              font-family:-apple-system,system-ui,sans-serif;
              background:#0f0f12;
              color:#fff;
              text-align:center;
            ">
              <div>
                <h2>‚õî √Ötkomst nekad, du √§r inte v√§rdig</h2>
                <p>Fel PIN-kod</p>
              </div>
            </div>
          `;
          return;
        }
        localStorage.setItem("appAuthorized", "1");
      })();

      // --- Elements ---
      const totalDoughInput = document.getElementById("totalDoughInput");
      const prefPct = document.getElementById("prefPct");
      const prefHyd = document.getElementById("prefHyd");
      const prefYeastPct = document.getElementById("prefYeastPct");
  	  const flourMixPct = document.getElementById("flourMixPct");
      const waterPct = document.getElementById("waterPct");
      const saltPct = document.getElementById("saltPct");
      const yeastPct = document.getElementById("yeastPct");
      const inputs = [totalDoughInput,prefPct,prefHyd,prefYeastPct,flourMixPct,waterPct,saltPct,yeastPct];
      
      const mainFlourEl = document.getElementById("mainFlour");
      const mainWaterEl = document.getElementById("mainWater");
      const saltEl = document.getElementById("salt");
      const yeastEl = document.getElementById("yeast");
      const mainTotalEl = document.getElementById("mainTotal");

      const totalFlourEl = document.getElementById("totalFlour");
      const totalWaterEl = document.getElementById("totalWater");
      const totalCheckEl = document.getElementById("totalCheck");

      const settingsBtn = document.getElementById("settingsBtn");
      const settingsPanel = document.getElementById("settingsPanel");

      const themeToggle = document.getElementById("themeToggle");
      const themeIcon = document.getElementById("themeIcon");

      const usePref = document.getElementById("usePref");
      const prefSection = document.getElementById("prefSection");
  	  const prefFlourEl = document.getElementById("prefFlour");
      const prefWaterEl = document.getElementById("prefWater");
      const prefYeastEl = document.getElementById("prefYeast");
      const prefTotalEl = document.getElementById("prefTotal");
	  
  	  const useFlourMix = document.getElementById("useFlourMix");
      const flourMixSection = document.getElementById("flourMixSection");
      const flourMixEl  = document.getElementById("flourMix");

      const recipeToggle = document.getElementById("recipeToggle");
      const recipeSelect = document.getElementById("recipeSelect");

      const recipeNameInput = document.getElementById("recipeNameInput");
      const saveRecipeBtn = document.getElementById("saveRecipeBtn");
      const deleteRecipeBtn = document.getElementById("deleteRecipeBtn");
      const exportBtn = document.getElementById("exportRecipesBtn");
      const importBtn = document.getElementById("importRecipesBtn");
      const importInput = document.getElementById("importRecipesInput");

      // --- Settings toggle ---
      settingsBtn.addEventListener("click",()=> settingsPanel.classList.toggle("open"));

      // --- Theme ---
      (() => {
        const savedTheme = localStorage.getItem("theme") || "dark";
        applyTheme(savedTheme);
        themeToggle.checked = savedTheme === "light";

        themeToggle.addEventListener("change",()=> {
          const theme = themeToggle.checked ? "light":"dark";
          applyTheme(theme);
          localStorage.setItem("theme", theme);
        });

        function applyTheme(theme){
          document.body.classList.remove("dark","light");
          document.documentElement.classList.remove("dark","light");
          document.body.classList.add(theme);
          document.documentElement.classList.add(theme);
          themeIcon.textContent = theme === "light"?"‚òÄÔ∏è":"üåô";
        }
      })();

      // --- Pref toggle ---
      (() => {
        const savedPref = localStorage.getItem("usePref") === "1";
        usePref.checked = savedPref;
        prefSection.classList.toggle("collapsed",!savedPref);
        if(!savedPref) prefPct.value=0;
        usePref.addEventListener("change",()=> {
          const on = usePref.checked;
          prefSection.classList.toggle("collapsed",!on);
          if(!on) prefPct.value=0;
          localStorage.setItem("usePref",on?"1":"0");
          recalc();
        });
      })();
	  
  	  // --- Flour mix toggle ---
      (() => {
        const saved = localStorage.getItem("useFlourMix") === "1";
        useFlourMix.checked = saved;
        flourMixSection.classList.toggle("collapsed", !saved);
        if (!saved) flourMixPct.value = 0;
        useFlourMix.addEventListener("change",()=> {
          const on = useFlourMix.checked;
          flourMixSection.classList.toggle("collapsed", !on);
          if (!on) flourMixPct.value = 0;
          localStorage.setItem("useFlourMix", on ? "1" : "0");
          recalc();
        });
      })();
      
      // --- Data toggle ---
      recipeToggle.addEventListener("change",()=> {
        recipeSection.classList.toggle("collapsed", !recipeToggle.checked);
      });

      // --- Recipes ---
      let recipes = JSON.parse(localStorage.getItem("recipes")||"[]");
      if(!Array.isArray(recipes)) recipes=[];
      refreshDropdown();
      saveRecipeBtn.addEventListener("click",()=> {
        const name = recipeNameInput.value.trim();
        if(!name)return alert("Skriv ett namn p√• receptet!");
        const newRecipe = {
          D:Number(totalDoughInput.value),
          P:Number(prefPct.value),
          PH:Number(prefHyd.value),
          PY:Number(prefYeastPct.value),
    		  FM:Number(flourMixPct.value),
          W:Number(waterPct.value),
          S:Number(saltPct.value),
          Y:Number(yeastPct.value),
          name
        };
        const index = recipes.findIndex(r =>
          r.name.toLowerCase() === name.toLowerCase()
        );
        if (index !== -1) {
          const ok = confirm(`"${name}" finns redan.\nVill du skriva √∂ver receptet?`);
          if (!ok) return;
          // skriv √∂ver befintligt recept
          recipes[index] = newRecipe;
        } else {
          // nytt recept
          recipes.push(newRecipe);
        }
        localStorage.setItem("recipes",JSON.stringify(recipes));
        refreshDropdown();
        recipeNameInput.value="";
      });

      deleteRecipeBtn.addEventListener("click",()=> {
        const idx = recipeSelect.value;
        if(idx === ""){ alert("V√§lj ett recept att radera."); return;}
        const name = recipes[idx].name;
        if(!confirm(`Radera receptet "${name}"?`)) return;
        recipes.splice(idx,1);
        localStorage.setItem("recipes",JSON.stringify(recipes));
        refreshDropdown();
        recipeSelect.value="";
      });

      function applyDefaults() {
        totalDoughInput.value = 1000;
        prefPct.value         = 0;
        prefHyd.value         = 100;
        prefYeastPct.value    = 0.1;
  	    flourMixPct.value     = 0;
        waterPct.value        = 65;
        saltPct.value         = 2.5;
        yeastPct.value        = 1.0;
        recalc();
      }

      function refreshDropdown(){
        // sortera alfabetiskt
        recipes.sort((a,b)=> 
          a.name.localeCompare(b.name,"sv", { sensitivity: "base" })
        );
        recipeSelect.innerHTML=`<option value="">‚Äì Inget recept ‚Äì</option>`;
        recipes.forEach((r,i)=> {
          const option=document.createElement("option");
          option.value=i;
          option.textContent=r.name;
          recipeSelect.appendChild(option);
        });
      }

      recipeSelect.addEventListener("change",()=> {
        const idx = recipeSelect.value;
        if (idx === "") {
          applyDefaults();
          // Reset f√∂rdeg
          usePref.checked = false;
          usePref.dispatchEvent(new Event("change"));
  	      // Reset mj√∂lmix
          useFlourMix.checked = false;
          useFlourMix.dispatchEvent(new Event("change"));
          return;
        }
        const r = recipes[idx];
        if (!r) return;
        totalDoughInput.value = Number(r.D) || 0;
        prefPct.value         = Number(r.P) || 0;
        prefHyd.value         = Number(r.PH) || 0;
        prefYeastPct.value    = Number(r.PY) || 0;
        flourMixPct.value     = Number(r.FM) || 0;
        waterPct.value        = Number(r.W) || 0;
        saltPct.value         = Number(r.S) || 0;
        yeastPct.value        = Number(r.Y) || 0;
        // toggles till f√∂rdeg/mj√∂lmix
        const hasPref = prefPct.value > 0;
        usePref.checked = hasPref;
        usePref.dispatchEvent(new Event("change"));
        const hasMix = flourMixPct.value > 0;
        useFlourMix.checked = hasMix;
        useFlourMix.dispatchEvent(new Event("change"));
        recalc();
      });

      exportBtn.addEventListener("click",()=> {
        if(!recipes.length)return alert("Inga recept att exportera!");
        const blob=new Blob([JSON.stringify(recipes,null,2)],{type:"application/json"});
        const url=URL.createObjectURL(blob);
        const a=document.createElement("a");
        a.href=url; a.download="recept.json"; a.click();
        URL.revokeObjectURL(url);
      });

      importBtn.addEventListener("click",()=> importInput.click());

      importInput.addEventListener("change",e=>{
        const file = e.target.files[0];
        if(!file)return;
        const reader=new FileReader();
        reader.onload=()=> {
          try{
            const imported = JSON.parse(reader.result);
            if(!Array.isArray(imported)) throw new Error("Felaktig fil! M√•ste vara en array av recept.");
            recipes = imported;
            localStorage.setItem("recipes",JSON.stringify(recipes));
            refreshDropdown();
            alert("Recept importerade!");
          }catch(err){ alert("Kunde inte importera fil: "+err.message); }
        };
        reader.readAsText(file);
      });
      
      // --- √Öterst√§ll data ---
      const resetAppBtn = document.getElementById("resetAppBtn");
      function hardResetApp() {
        const ok = confirm("√Öterst√§ll appen helt till grundl√§ge?\nAll lokal data raderas, recept etc.");
        if (!ok) return;
          localStorage.clear();
          location.reload();
      }
      resetAppBtn.addEventListener("click", hardResetApp);
      
      // --- Recalc ---
      function recalc(){
        const D  = Number(totalDoughInput.value); if(!D || D<=0)return;
        const P  = Number(prefPct.value)/100;
        const PH = Number(prefHyd.value)/100;
        const PY = Number(prefYeastPct.value)/100;
        const FM = Number(flourMixPct.value)/100;
        const W  = Number(waterPct.value)/100;
        const S  = Number(saltPct.value)/100;
        const Y  = Number(yeastPct.value)/100;

        const totalFlour = D/(1+W+S+Y);
        const totalWater = totalFlour*W;
        const salt = totalFlour*S;
        const totalYeast = totalFlour*Y;

        const prefFlour = totalFlour*P;
        const prefWater = Math.min(prefFlour*PH,totalWater);
        const prefYeast = prefFlour*PY;
        const prefTotal = prefFlour+prefWater+prefYeast;

        const mainFlour = totalFlour-prefFlour;
        const mainWater = Math.max(totalWater-prefWater,0);
        const mainYeast = totalYeast-prefYeast;
        const mainTotal = mainFlour+mainWater+mainYeast+salt;
        
        const flourMix  = mainFlour * FM;

        prefFlourEl.textContent = Math.round(prefFlour);
        prefWaterEl.textContent = Math.round(prefWater);
        prefYeastEl.textContent = prefYeast.toFixed(1);
        prefTotalEl.textContent = Math.round(prefTotal);

        mainFlourEl.textContent = Math.round(mainFlour - flourMix);
        mainWaterEl.textContent = Math.round(mainWater);
        saltEl.textContent = salt.toFixed(1);
        yeastEl.textContent = mainYeast.toFixed(1);
        mainTotalEl.textContent = Math.round(mainTotal);
        
        flourMixEl.textContent  = Math.round(flourMix);

        totalFlourEl.textContent = Math.round(totalFlour);
        totalWaterEl.textContent = Math.round(totalWater);
        totalCheckEl.textContent = Math.round(prefTotal+mainTotal);
      }

      // --- Persist inputs ---
      inputs.forEach(input=>{
        const saved = localStorage.getItem(input.id);
        if(saved!==null) input.value=saved;
        input.addEventListener("input",()=> { 
  		  localStorage.setItem(input.id,input.value);
    		  recalc();
    		});
      });

      recalc();
    });
  </script>
</body>
</html>
